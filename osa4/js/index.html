<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/component---src-templates-content-template-js.bb6688043828bda42216.css">@import url(https://fonts.googleapis.com/css?family=IBM+Plex+Mono:400,500,600);.course{position:relative}.course h1,.course h2,.course h3,.course h4,.course p{margin-left:3rem;padding-bottom:2rem}.course pre{margin:2rem 0;background-color:#33332d;color:#fff}.course img{border:11px solid transparent}.course a{border:0;border-bottom:2px;border-style:solid;border-color:transparent;padding:2px}.course .banner,.course .container{position:static}.course .letter{width:4rem;height:4rem;border-width:5px;border-style:solid;border-radius:2.5rem;text-align:center;margin:1rem;line-height:.8em}@media (min-width:640px){.course .letter{-webkit-transform:translate(-3rem,5rem);transform:translate(-3rem,5rem)}}.course .letter,.course h1{font-size:3.444rem;font-weight:700}.course li{list-style-type:none}.course li:before{content:"-";margin-right:1rem}.arrow__container{position:relative}.arrow__container:not():first-child{border-left:none}.arrow__container:not():first-child:before{content:"";background:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NzcuMTc1IDQ3Ny4xNzUiPjxwYXRoIGQ9Ik0zNjAuNzMxIDIyOS4wNzVsLTIyNS4xLTIyNS4xYy01LjMtNS4zLTEzLjgtNS4zLTE5LjEgMHMtNS4zIDEzLjggMCAxOS4xbDIxNS41IDIxNS41LTIxNS41IDIxNS41Yy01LjMgNS4zLTUuMyAxMy44IDAgMTkuMSAyLjYgMi42IDYuMSA0IDkuNSA0IDMuNCAwIDYuOS0xLjMgOS41LTRsMjI1LjEtMjI1LjFjNS4zLTUuMiA1LjMtMTMuOC4xLTE5eiIvPjwvc3ZnPg==) no-repeat;background-size:contain;position:absolute;top:0;left:0;height:100%;width:100%}.arrows--horizontal{display:flex;position:relative;margin:0;align-items:flex-start}.arrow__wrapper{display:flex;justify-content:flex-start;align-items:center;margin:0}.arrow__wrapper:first-of-type{border-right:none;z-index:20}.arrow__wrapper:nth-of-type(n+2){margin-left:-4rem;z-index:10}.arrow__wrapper:nth-of-type(n+2) .arrow__rectangle{border-left:none;padding-left:4rem}.arrow__wrapper:nth-of-type(3){z-index:5}.arrow__rectangle{padding:1rem;justify-content:center;align-items:center;border:2px solid #33332d;border-right:none;z-index:2;overflow:hidden}.arrow__rectangle .bold{font-weight:600}.arrow__rectangle--thick-border{border:3px solid #33332d;border-right:none}.arrow__point{padding:1.25rem;border:2px solid #33332d;border-bottom:none;border-left:none;-webkit-transform:translate(-1.3rem) rotate(45deg);transform:translate(-1.3rem) rotate(45deg);z-index:1;overflow:hidden}.arrow__point--thick-border{border:3px solid #33332d;border-bottom:none;border-left:none}.arrow__wrapper--stacked{display:flex;justify-content:flex-start;align-items:center;margin:auto auto auto 0}.arrow__wrapper--stacked:nth-of-type(n+2){margin-top:-2px}.arrow--stacked-letter{margin-right:2rem}.arrow--stacked-title{text-transform:uppercase;white-space:nowrap}.arrow__container--with-link{width:100%!important}.element--flex{display:flex;flex-wrap:wrap}.element--space-around{justify-content:space-around}.element--space-between{justify-content:space-between}.element--column{flex-direction:column}.element--centered{align-items:center}.element--horizontal-half{width:45%}.element--auto-bottom-margin{margin-bottom:auto}.element--flex-start{align-content:flex-start}.banner{display:flex;align-items:center;position:relative;padding:2.22rem 0;background-color:#e1e1e1}@media (min-width:992px){.banner{padding:3.444rem 3.444rem 4.444rem}}html{font-family:IBM Plex Mono,monospace;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:IBM Plex Mono,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.45em IBM Plex Mono,monospace;box-sizing:border-box;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{color:rgba(0,0,0,.8);font-family:IBM Plex Mono,monospace;font-weight:400;word-wrap:break-word;-webkit-font-kerning:normal;font-kerning:normal;-ms-font-feature-settings:"kern","liga","clig","calt";-webkit-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt"}img{max-width:100%;padding:0;margin:0 0 1.45rem}h1{font-size:2.25rem}h1,h2{padding:0;margin:0 0 1.45rem;color:inherit;font-family:IBM Plex Mono,monospace;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{padding:0;margin:0 0 1.45rem;color:inherit;font-family:IBM Plex Mono,monospace;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{padding:0;margin:0 0 1.45rem;color:inherit;font-family:IBM Plex Mono,monospace;font-weight:700;text-rendering:optimizeLegibility;line-height:1.1}h6{font-size:.78405rem}hgroup{padding:0;margin:0 0 1.45rem}ol,ul{padding:0;margin:0 0 1.45rem 1.45rem;list-style-position:outside;list-style-image:none}dd,dl,figure,p{padding:0;margin:0 0 1.45rem}pre{margin:0 0 1.45rem;font-size:.85rem;line-height:1.42;background:rgba(0,0,0,.04);border-radius:3px;overflow:auto;word-wrap:normal;padding:1.45rem}table{font-size:1rem;line-height:1.45rem;border-collapse:collapse;width:100%}fieldset,table{padding:0;margin:0 0 1.45rem}blockquote{padding:0;margin:0 1.45rem 1.45rem}form,iframe,noscript{padding:0;margin:0 0 1.45rem}hr{padding:0;margin:0 0 calc(1.45rem - 1px);background:rgba(0,0,0,.2);border:none;height:1px}address{padding:0;margin:0 0 1.45rem}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-left:1.45rem;margin-bottom:.725rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{border-bottom:1px solid rgba(0,0,0,.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{letter-spacing:-.2em;content:" "}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}body,html{margin:0;padding:0;font-family:IBM Plex Mono,monospace;font-weight:500;color:#33332d;font-size:14px;line-height:1.555rem}@media (min-width:992px){body,html{font-size:18px}}body{padding-top:120px}@media (min-width:992px){body{padding-top:90px}}p{margin:0;text-align:left;line-height:1.5em}a,p{color:#33332d}a{text-decoration:none}.container{position:relative;margin:0 auto;display:flex;flex-wrap:wrap;justify-content:space-between;width:90%;max-width:1200px}.hidden{display:none!important}.centered{text-align:center}.spacing{margin-top:2.22rem}@media (min-width:992px){.spacing{margin-top:5.55rem}}.spacing--small{margin-top:1.11rem}@media (min-width:992px){.spacing--small{margin-top:3.444rem}}.spacing--large{margin-top:4.44rem}@media (min-width:992px){.spacing--large{margin-top:11.1rem}}.spacing--extra-large{margin-top:4.44rem}@media (min-width:992px){.spacing--extra-large{margin-top:22.2rem}}.spacing--after{margin-bottom:2.22rem}@media (min-width:992px){.spacing--after{margin-bottom:5.55rem}}.spacing--after-small{margin-bottom:1.11rem}@media (min-width:992px){.spacing--after-small{margin-bottom:2.775rem}}.spacing--after-large{margin-bottom:4.44rem}@media (min-width:992px){.spacing--after-large{margin-bottom:11.1rem}}@media (max-width:991px){.spacing--mobile{margin-top:2.22rem}}.col-1{width:100%}@media (min-width:992px){.col-1{width:10%}}.col-2{width:100%}@media (min-width:992px){.col-2{width:20%}}.col-3{width:100%}@media (min-width:992px){.col-3{width:30%}}.col-4{width:100%}@media (min-width:992px){.col-4{width:40%}}.col-5{width:100%}@media (min-width:992px){.col-5{width:50%}}.col-6{width:100%}@media (min-width:992px){.col-6{width:60%}}.col-7{width:100%}@media (min-width:992px){.col-7{width:70%}}.col-8{width:100%}@media (min-width:992px){.col-8{width:80%}}.col-9{width:100%}@media (min-width:992px){.col-9{width:90%}}.col-10{width:100%}@media (min-width:992px){.col-10{width:100%}}@media (min-width:992px){.push-right-1{margin-left:10%}.push-right-2{margin-left:20%}.push-right-3{margin-left:30%}.push-right-4{margin-left:40%}.push-right-5{margin-left:50%}.push-left-1{margin-right:10%}.push-left-2{margin-right:20%}.push-left-3{margin-right:30%}.push-left-4{margin-right:40%}.push-left-5{margin-right:50%}.push-left{margin-right:auto}.push-right{margin-left:auto}}@media (max-width:991px){.col-5--mobile{width:50%}.col-10--mobile{width:100%}.order-0--mobile{order:0}.order-1--mobile{order:1}.order-2--mobile{order:2}.order-3--mobile{order:3}.order-4--mobile{order:4}.order-5--mobile{order:5}.hidden--mobile{display:none}}.centered-vertically{display:flex;flex-direction:column;justify-content:center}.nav-item-hover{font-size:1.111rem;font-weight:600;text-decoration:none;color:#33332d;padding:.2em}.nav-item-hover:active,.nav-item-hover:focus,.nav-item-hover:hover{color:#fff;background-color:#33332d}.nav-item-hover:active,.nav-item-hover:focus{outline:2px solid #706be4}.flex-fix-aligning:after,.flex-fix-aligning:before{content:"";width:30%;order:2}#footer .nav-item-hover{font-size:.777rem;font-weight:500}.triple-border{margin:5px;position:relative;padding:2px;border-radius:5px 0;transition:color .1s ease-in-out,background-color .1s ease-in-out}.triple-border:after,.triple-border:before{content:"";border:2px solid #33332d;border-radius:5px;position:absolute;width:calc(100% + 5px);height:calc(100% + 5px)}.triple-border:before{left:0;top:0}.triple-border:after{bottom:0;right:0}.triple-border__container{overflow:hidden;border-radius:3px 0}.triple-border--large-margin{margin:13px;padding:3px}.triple-border--large-margin:after,.triple-border--large-margin:before{content:"";border-width:3px;border-radius:13px;width:calc(100% + 13px);height:calc(100% + 13px)}.triple-border--large-margin .triple-border__container{border-radius:10px 0}.triple-border__logo{padding:.2rem;font-size:1.111rem;font-weight:600}.triple-border__return-tasks{font-size:.9rem;padding:1rem .2rem}.body-text:not(:last-of-type){margin-bottom:2.775rem}.body-text__title{color:#33332d;font-size:1.44rem;line-height:1.25em;font-weight:700;margin:0;position:relative;top:50%;-webkit-transform:translateY(-50%);transform:translateY(-50%)}.body-text__content:not(:last-of-type){padding-bottom:2em}.bold{font-weight:700}.body-text--no-padding{padding:0!important}.scroll-navigation li:hover{cursor:pointer;background-color:#000;color:#fff}.sub-header{color:#33332d;font-family:IBM Plex Mono,monospace;padding-bottom:1.357rem}@media (min-width:992px){.sub-header{padding-bottom:2.333rem}}</style><meta name="generator" content="Gatsby 2.0.53"/><title data-react-helmet="true"></title><link rel="shortcut icon" href="/icons/icon-48x48.png"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link as="script" rel="preload" href="/component---src-templates-content-template-js-1511b04e7342894ff772.js"/><link as="script" rel="preload" href="/2-a8e181bf0eaee510a2de.js"/><link as="script" rel="preload" href="/app-e57bcd659185b811abbf.js"/><link as="script" rel="preload" href="/webpack-runtime-f53c77243ffa0d20d678.js"/><link rel="preload" href="/static/d/72/path---osa-4-js-65-b-ed7-lcJlpuLgXfdtL7JsyCCTaq7h5RM.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div><div class="container" style="align-items:center"><a style="text-decoration:none" href="/"><div class="triple-border nav-item-hover " style="padding:0.2em"><div class="triple-border__container triple-border__logo" style="background-color:transparent">{() =&gt; fs}</div></div></a><div class="col-4 push-left-4" style="display:flex;justify-content:space-between;font-weight:bold"><a class="nav-item-hover" href="/about">KURSSISTA</a><a class="nav-item-hover" href="/faq">FAQs</a><a class="nav-item-hover" href="/companies">YRITYSESITTELYT</a></div></div><div class="spacing--small spacing--after"><div class="course-container"><div class="banner spacing--after" style="background-image:url(/static/osa5-8edc6044aad809a3143dc36c5e7f3b4c.png);background-position:center center;background-size:80%;background-repeat:no-repeat;background-color:#F7F382"><div class="container"><div class="col-10 spacing spacing--after"><div class="arrow__container arrows--horizontal"><div class="arrow__wrapper "><div class="arrow__rectangle  " style="background-color:#F7F382;color:black">YLEISTÄ</div><div class="arrow__point " style="background-color:#F7F382;color:black"></div></div><div class="arrow__wrapper "><div class="arrow__rectangle  " style="background-color:#F7F382;color:black">OSA 4 YLEISTÄ</div><div class="arrow__point " style="background-color:#F7F382;color:black"></div></div><div class="arrow__wrapper "><div class="arrow__rectangle  " style="background-color:black;color:white">JS</div><div class="arrow__point " style="background-color:black;color:white"></div></div></div></div></div></div><div class="course"><div class="container"><div class="col-7 course-content push-right-3" style="border-color:#F7F382"><p class="col-1 letter" style="border-color:#F7F382">c</p><h1 class="sub-header ">JS</h1></div></div><div class="container"><div class="scroll-navigation col-3 element--flex element--column"></div><div class="course-content col-7">
<h3>virheiden käsittely ja async/await</h3>
<p>Jos sovellus POST-pyyntöä käsitellessään aiheuttaa jonkinlaisen ajonaikaisen virheen, syntyy jälleen tuttu tilanne:</p>
<pre>

(node:30644) UnhandledPromiseRejectionWarning: Unhandled promise rejection (rejection id: 1): TypeError: formattedNote.nonexistingMethod is not a function
</pre>
<p>eli käsittelemätön promisen rejektoituminen. Pyyntöön ei vastata tilanteessa mitenkään.</p>
<p>Async/awaitia käyttäessä kannattaa käyttää vanhaa kunnon <em>try/catch</em>-mekanismia virheiden käsittelyyn:</p>
<pre><code class="language-js">notesRouter.post(&#x27;/&#x27;, async (request, response) =&gt; {
  try {
    const body = request.body;

    if (body.content === undefined) {
      return response.status(400).json({ error: &#x27;content missing&#x27; });
    }

    const note = new Note({
      content: body.content,
      important: body.important === undefined ? false : body.important,
      date: new Date(),
    });

    const savedNote = await note.save();
    response.json(formatNote(note));
  } catch (exception) {
    console.log(exception);
    response.status(500).json({ error: &#x27;something went wrong...&#x27; });
  }
});
</code></pre>
<p>Iso try/catch tuo koodiin hieman ikävän vivahteen, mutta mikään ei ole ilmaista.</p>
<p>Tehdään sitten testit yksittäisen muistiinpanon tietojen katsomiselle ja muistiinpanon poistolle:</p>
<pre><code class="language-js">test(&#x27;a specific note can be viewed&#x27;, async () =&gt; {
  const resultAll = await api
    .get(&#x27;/api/notes&#x27;)
    .expect(200)
    .expect(&#x27;Content-Type&#x27;, /application\/json/);

  const aNoteFromAll = resultAll.body[0];

  const resultNote = await api.get(`/api/notes/${aNoteFromAll.id}`);

  const noteObject = resultNote.body;

  expect(noteObject).toEqual(aNoteFromAll);
});

test(&#x27;a note can be deleted&#x27;, async () =&gt; {
  const newNote = {
    content: &#x27;HTTP DELETE poistaa resurssin&#x27;,
    important: true,
  };

  const addedNote = await api.post(&#x27;/api/notes&#x27;).send(newNote);

  const notesAtBeginningOfOperation = await api.get(&#x27;/api/notes&#x27;);

  await api.delete(`/api/notes/${addedNote.body.id}`).expect(204);

  const notesAfterDelete = await api.get(&#x27;/api/notes&#x27;);

  const contents = notesAfterDelete.body.map(r =&gt; r.content);

  expect(contents).not.toContain(&#x27;HTTP DELETE poistaa resurssin&#x27;);
  expect(notesAfterDelete.body.length).toBe(
    notesAtBeginningOfOperation.body.length - 1
  );
});
</code></pre>
<p>Testit eivät tässä vaiheessa ole optimaaliset, parannetaan niitä kohta. Ensin kuitenkin refaktoroidaan backend käyttämään async/awaitia.</p>
<pre><code class="language-js">notesRouter.get(&#x27;/:id&#x27;, async (request, response) =&gt; {
  try {
    const note = await Note.findById(request.params.id);

    if (note) {
      response.json(formatNote(note));
    } else {
      response.status(404).end();
    }
  } catch (exception) {
    console.log(exception);
    response.status(400).send({ error: &#x27;malformatted id&#x27; });
  }
});

notesRouter.delete(&#x27;/:id&#x27;, async (request, response) =&gt; {
  try {
    await Note.findByIdAndRemove(request.params.id);

    response.status(204).end();
  } catch (exception) {
    console.log(exception);
    response.status(400).send({ error: &#x27;malformatted id&#x27; });
  }
});
</code></pre>
<p>Async/await ehkä selkeyttää koodia jossain määrin, mutta saavutettava hyöty ei ole sovelluksessamme vielä niin iso mitä se tulee olemaan jos asynkronisia kutsuja on tehtävä useampia.</p>
<p>Kaikki eivät kuitenkaan ole vakuuttuneita siitä, että async/await on hyvä lisä Javascriptiin, lue esim. <a href="https://spion.github.io/posts/es7-async-await-step-in-the-wrong-direction.html">ES7 async functions - a step in the wrong direction</a></p>
<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part3-notes-backend/tree/part4-4">githubissa</a>, tagissa <em>part4-4</em>. Samassa on &quot;vahingossa&quot; mukana testeistä seuraavan luvun jälkeinen paranneltu versio.</p>
<h3>Varoitus</h3>
<p>Jos huomaat kirjoittavasi sekaisin async/awaitia ja <em>then</em>-kutsuja, on 99% varmaa, että teet jotain väärin. Käytä siis jompaa kumpaa tapaa, älä missään tapauksessa &quot;varalta&quot; molempia.</p>
<h2>Tehtäviä</h2>
<p>Tee nyt tehtävät <a href="/teht%C3%A4v%C3%A4t/#apin-testaaminen">4.8-4.11</a></p>
<h2>Testien refaktorointi</h2>
<p>Testimme sisältävät tällä hetkellä jossain määrin toisteisuutta ja niiden rakenne ei ole optimaalinen. Testit ovat myös osittain epätäydelliset, esim. reittejä GET /api/notes/:id ja DELETE /api/notes/:id ei tällä hetkellä testata epävalidien id:iden osalta.</p>
<p>Testeissä on myös eräs hieman ikävä ja jopa riskialtis piirre. Testit luottavat siihen, että ne suoritetaan siinä järjestyksessä, missä ne on kirjoitettu testitiedostoon. Tämä pitää kyllä paikkansa, vaikkakin se ei ole kovin selkeästi määritelty ominaisuus eli siihen ei ole hyvä luottaa. Testit tuleekin kirjoittaa siten, että yksittäiset testit ovat riippumattomia toistensa suorituksesta.</p>
<p>Parannellaan testejä hiukan.</p>
<p>Tehdään testejä varten muutama apufunktio moduuliin <em>tests/test</em>helper.js_</p>
<pre><code class="language-js">const Note = require(&#x27;../models/note&#x27;);

const initialNotes = [
  {
    content: &#x27;HTML on helppoa&#x27;,
    important: false,
  },
  {
    content: &#x27;HTTP-protokollan tärkeimmät metodit ovat GET ja POST&#x27;,
    important: true,
  },
];

const format = note =&gt; {
  return {
    content: note.content,
    important: note.important,
    id: note._id,
  };
};

const nonExistingId = async () =&gt; {
  const note = new Note();
  await note.save();
  await note.remove();

  return note._id.toString();
};

const notesInDb = async () =&gt; {
  const notes = await Note.find({});
  return notes.map(format);
};

module.exports = {
  initialNotes,
  format,
  nonExistingId,
  notesInDb,
};
</code></pre>
<p>Tärkein apufunktioista on <em>notesInDb</em> joka palauttaa kaikki tietokannassa kutsuhetkellä olevat oliot.</p>
<p>Jossain määrin parannellut testit seuraavassa:</p>
<pre><code class="language-js">const supertest = require(&#x27;supertest&#x27;);
const { app, server } = require(&#x27;../index&#x27;);
const api = supertest(app);
const Note = require(&#x27;../models/note&#x27;);
const {
  format,
  initialNotes,
  nonExistingId,
  notesInDb,
} = require(&#x27;./test_helper&#x27;);

describe(&#x27;when there is initially some notes saved&#x27;, async () =&gt; {
  beforeAll(async () =&gt; {
    await Note.remove({});

    const noteObjects = initialNotes.map(n =&gt; new Note(n));
    await Promise.all(noteObjects.map(n =&gt; n.save()));
  });

  test(&#x27;all notes are returned as json by GET /api/notes&#x27;, async () =&gt; {
    const notesInDatabase = await notesInDb();

    const response = await api
      .get(&#x27;/api/notes&#x27;)
      .expect(200)
      .expect(&#x27;Content-Type&#x27;, /application\/json/);

    expect(response.body.length).toBe(notesInDatabase.length);

    const returnedContents = response.body.map(n =&gt; n.content);
    notesInDatabase.forEach(note =&gt; {
      expect(returnedContents).toContain(note.content);
    });
  });

  test(&#x27;individual notes are returned as json by GET /api/notes/:id&#x27;, async () =&gt; {
    const notesInDatabase = await notesInDb();
    const aNote = notesInDatabase[0];

    const response = await api
      .get(`/api/notes/${aNote.id}`)
      .expect(200)
      .expect(&#x27;Content-Type&#x27;, /application\/json/);

    expect(response.body.content).toBe(aNote.content);
  });

  test(&#x27;404 returned by GET /api/notes/:id with nonexisting valid id&#x27;, async () =&gt; {
    const validNonexistingId = await nonExistingId();

    const response = await api
      .get(`/api/notes/${validNonexistingId}`)
      .expect(404);
  });

  test(&#x27;400 is returned by GET /api/notes/:id with invalid id&#x27;, async () =&gt; {
    const invalidId = &#x27;5a3d5da59070081a82a3445&#x27;;

    const response = await api.get(`/api/notes/${invalidId}`).expect(400);
  });

  describe(&#x27;addition of a new note&#x27;, async () =&gt; {
    test(&#x27;POST /api/notes succeeds with valid data&#x27;, async () =&gt; {
      const notesAtStart = await notesInDb();

      const newNote = {
        content: &#x27;async/await yksinkertaistaa asynkronisten funktioiden kutsua&#x27;,
        important: true,
      };

      await api
        .post(&#x27;/api/notes&#x27;)
        .send(newNote)
        .expect(200)
        .expect(&#x27;Content-Type&#x27;, /application\/json/);

      const notesAfterOperation = await notesInDb();

      expect(notesAfterOperation.length).toBe(notesAtStart.length + 1);

      const contents = notesAfterOperation.map(r =&gt; r.content);
      expect(contents).toContain(
        &#x27;async/await yksinkertaistaa asynkronisten funktioiden kutsua&#x27;
      );
    });

    test(&#x27;POST /api/notes fails with proper statuscode if content is missing&#x27;, async () =&gt; {
      const newNote = {
        important: true,
      };

      const notesAtStart = await notesInDb();

      await api
        .post(&#x27;/api/notes&#x27;)
        .send(newNote)
        .expect(400);

      const notesAfterOperation = await notesInDb();

      const contents = notesAfterOperation.map(r =&gt; r.content);

      expect(notesAfterOperation.length).toBe(notesAtStart.length);
    });
  });

  describe(&#x27;deletion of a note&#x27;, async () =&gt; {
    let addedNote;

    beforeAll(async () =&gt; {
      addedNote = new Note({
        content: &#x27;poisto pyynnöllä HTTP DELETE&#x27;,
        important: false,
      });
      await addedNote.save();
    });

    test(&#x27;DELETE /api/notes/:id succeeds with proper statuscode&#x27;, async () =&gt; {
      const notesAtStart = await notesInDb();

      await api.delete(`/api/notes/${addedNote._id}`).expect(204);

      const notesAfterOperation = await notesInDb();

      const contents = notesAfterOperation.map(r =&gt; r.content);

      expect(contents).not.toContain(addedNote.content);
      expect(notesAfterOperation.length).toBe(notesAtStart.length - 1);
    });
  });

  afterAll(() =&gt; {
    server.close();
  });
});
</code></pre>
<p>Muutama huomio testeistä. Olemme jaotelleet testejä <a href="http://facebook.github.io/jest/docs/en/api.html#describename-fn">describe</a>-lohkojen avulla ja muutamissa lohkoissa on oma <a href="http://facebook.github.io/jest/docs/en/api.html#beforeallfn-timeout">beforeAll</a>-funktiolla suoritettava alustuskoodi.</p>
<p>Joissain tapauksissa tämä olisi parempi tehdä operaatiolla <a href="https://facebook.github.io/jest/docs/en/api.html#beforeeachfn-timeout">beforeEach</a>, joka suoritetaan <em>ennen jokaista testiä</em>, näin testeistä saisi varmemmin toisistaan riippumattomia. Esimerkissä beforeEachia ei kuitenkaan ole käytetty.</p>
<p>Testien raportointi tapahtuu <em>describe</em>-lohkojen ryhmittelyn mukaan:</p>
<picture><img style="border-color:#F7F382" alt="asd" src="/static/fb864403ed08f27b73849e774e120969/14be6/5.png"/></picture>
<p>Backendin tietokannan tilaa muuttavat testit, esim. uuden muistiinpanon lisäämistä testaava testi <em>&#x27;addition of a new note&#x27;</em>, on tehty siten, että ne ensin aluksi selvittävät tietokannan tilan apufunktiolla <em>notesInDb()</em></p>
<pre><code class="language-js">const notesAtBeginningOfOperation = await notesInDb();
</code></pre>
<p>suorittavat testattavan operaation:</p>
<pre><code class="language-js">const newNote = {
  content: &#x27;async/await yksinkertaistaa asynkronisten funktioiden kutsua&#x27;,
  important: true,
};

await api
  .post(&#x27;/api/notes&#x27;)
  .send(newNote)
  .expect(200)
  .expect(&#x27;Content-Type&#x27;, /application\/json/);
</code></pre>
<p>selvittävät tietokannan tilan operaation jälkeen</p>
<pre><code class="language-js">const notesAfterOperation = await notesInDb();
</code></pre>
<p>ja varmentavat, että operaation suoritus vaikutti tietokantaan halutulla tavalla</p>
<pre><code class="language-js">expect(notesAfterOperation.length).toBe(notesAtBeginningOfOperation.length + 1);

const contents = notesAfterOperation.map(r =&gt; r.content);
expect(contents).toContain(
  &#x27;async/await yksinkertaistaa asynkronisten funktioiden kutsua&#x27;
);
</code></pre>
<p>Testeihin jää vielä paljon parannettavaa mutta on jo aika siirtyä eteenpäin.</p>
<p>Käytetty tapa API:n testaamiseen, eli HTTP-pyyntöinä tehtävät operaatiot ja tietokannan tilan tarkastelu Mongoosen kautta ei ole suinkaan ainoa tai välttämättä edes paras tapa tehdä API-tason integraatiotestausta. Universaalisti parasta tapaa testien tekoon ei ole, vaan kaikki on aina suhteessa käytettäviin resursseihin ja testattavaan ohjelmistoon.</p>
<h2>Tehtäviä</h2>
<p>Tee nyt tehtävät <a href="/teht%C3%A4v%C3%A4t#lis%C3%A4%C3%A4-toiminnallisuutta-ja-testej%C3%A4">4.12-4.14</a></p>
</div></div></div><div class="container spacing element--flex element--column element--centered"><div class="body-text "><p class="body-text__content bold">Tehtävien palautus</p></div><a href="https://studies.cs.helsinki.fi/fullstackopen/" style="padding:1rem 0" class="col-2 centered spacing--small"><div class="triple-border  triple-border--large-margin" style="padding:"><div class="triple-border__container triple-border__return-tasks" style="background-color:transparent">Palauta tehtävät palautussovellukseen</div></div></a></div><div class="container spacing spacing--after-large "><a class="push-right-1" href="/osa3"><div class=" element--flex element--column"><p style="text-align:right">Osa <!-- -->3</p><b>Edellinen osa</b></div></a><a class="push-left-1" href="/osa5"><div class=" element--flex element--column"><p>Osa <!-- -->5</p><b>Seuraava osa</b></div></a></div></div></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-content-template-js","jsonName":"osa-4-js-65b","path":"/osa4/js"};window.dataPath="72/path---osa-4-js-65-b-ed7-lcJlpuLgXfdtL7JsyCCTaq7h5RM";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-e57bcd659185b811abbf.js"],"component---src-templates-content-template-js":["/component---src-templates-content-template-js.bb6688043828bda42216.css","/component---src-templates-content-template-js-1511b04e7342894ff772.js"],"component---src-pages-404-js":["/component---src-pages-404-js-d105615186347619f3ea.js"],"component---src-pages-about-js":["/component---src-pages-about-js.9cb33badb6596f6554cf.css","/component---src-pages-about-js-33d39daca86354262832.js"],"component---src-pages-companies-js":["/component---src-pages-companies-js-8ccc1ef3cfee87833041.js"],"component---src-pages-faq-js":["/component---src-pages-faq-js-ac90fd3ee9c727a46e04.js"],"component---src-pages-index-js":["/component---src-pages-index-js.054d4c52cecca6da6c62.css","/component---src-pages-index-js-ff419c65d16d8fc5151e.js"],"component---src-pages-osa-0-js":["/component---src-pages-osa-0-js.b8658faab52da8be69f9.css","/component---src-pages-osa-0-js-682a2c381407db664b80.js"],"component---src-pages-osa-1-js":["/component---src-pages-osa-1-js.b8658faab52da8be69f9.css","/component---src-pages-osa-1-js-cfb35b424d9c77593938.js"],"component---src-pages-osa-2-js":["/component---src-pages-osa-2-js.b8658faab52da8be69f9.css","/component---src-pages-osa-2-js-839c7c09aa8e4a4c13d9.js"],"component---src-pages-osa-3-js":["/component---src-pages-osa-3-js.b8658faab52da8be69f9.css","/component---src-pages-osa-3-js-31955868da18833a534d.js"],"component---src-pages-osa-4-js":["/component---src-pages-osa-4-js.b8658faab52da8be69f9.css","/component---src-pages-osa-4-js-088ab9adfd67fa602964.js"],"component---src-pages-osa-5-js":["/component---src-pages-osa-5-js.b8658faab52da8be69f9.css","/component---src-pages-osa-5-js-1d2b2336913251264af9.js"],"component---src-pages-osa-6-js":["/component---src-pages-osa-6-js.b8658faab52da8be69f9.css","/component---src-pages-osa-6-js-1114c8fcf3edaff242ce.js"],"component---src-pages-osa-7-js":["/component---src-pages-osa-7-js.b8658faab52da8be69f9.css","/component---src-pages-osa-7-js-e06c5739a667540a2af6.js"]};/*]]>*/</script><script src="/webpack-runtime-f53c77243ffa0d20d678.js" async=""></script><script src="/app-e57bcd659185b811abbf.js" async=""></script><script src="/2-a8e181bf0eaee510a2de.js" async=""></script><script src="/component---src-templates-content-template-js-1511b04e7342894ff772.js" async=""></script></body></html>